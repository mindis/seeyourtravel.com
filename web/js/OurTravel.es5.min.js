"use strict";function showDialog(n){facebookAPIIsLoaded?$("#"+n).dialog({width:550,minHeight:400,maxHeight:600}):toastr.warning("Please wait, Facebook code is not loaded yet","",{timeOut:1e3,extendedTimeOut:2e3})}function pointToLatLng(n){var t,i,r;return n.hasOwnProperty("lat")?(t=new L.LatLng(n.lat,n.lng),n.hasOwnProperty("syt_text")&&(t.syt_text=n.syt_text),n.hasOwnProperty("syt_audio")&&(t.syt_audio=n.syt_audio),t):(i=n[0],r=n[1],t=new L.LatLng(i,r),n.length>2&&(t.syt_text=n[2],n.length>3&&(t.syt_audio=n[3])),t)}function translateTracksPath(n){return tracksFolder+n}function translateTracksContentPath(n){return tracksFolder+"content/"+n}function clickHelp(){$("#menuPanel").hide("slide",500);$("#helpPanel").show("slide",{direction:"right"},500)}function clickSettings(){$("#menuPanel").hide("slide",500);$("#settingsPanel").show("slide",{direction:"up"},500)}function clickMenu(){$("#helpPanel").hide("slide",{direction:"right"},500);$("#settingsPanel").hide("slide",{direction:"up"},500);$("#menuPanel").toggle("slide",500)}function onBodyResize(){$("#map").length&&$("#map").height(window.innerHeight);$("#menuPanel").length&&$("#menuPanel").height(window.innerHeight-100);$(".viewport").length&&$(".viewport").height(window.innerHeight-150);typeof switchSidePanel!="undefined"&&(window.innerWidth<800&&showSidePanel!="no"?switchSidePanel(!1):switchSidePanel(!0))}function showLocation(){if(navigator.geolocation)navigator.geolocation.getCurrentPosition(showPosition,errorPosition,{enableHighAccuracy:!0,timeout:3e4,maximumAge:3e5}),setTimeout(arguments.callee,3e5)}function errorPosition(n){console.warn("Cannot get position("+n.code+"): "+n.message)}function showPosition(n){var i,t;$("#map").length&&(i=new L.LatLng(n.coords.latitude,n.coords.longitude),markerWhereIAm.setLatLng(i),typeof track=="undefined"&&map.setView(i,8),t="services/user_locations.aspx?action=senduserlocation&userId="+globalUserId+"&lat="+n.coords.latitude.toString()+"&lng="+n.coords.longitude.toString(),$.ajax({dataType:"jsonp",url:t,success:function(){},error:function(n,t,i){console.log("senduserlocation error status: "+t);console.log("Error: "+i)}}),t="services/user_locations.aspx?action=getfriendslocations&userId="+globalUserId,markersFriends.clearLayers(),$.ajax({dataType:"jsonp",url:t,success:function(n){var t,i;for(t in n)i=L.marker(new L.LatLng(n[t].lat-.0002+Math.random()*.0004,n[t].lng-.0002+Math.random()*.0004),{icon:iconFriend}).bindPopup(n[t].userName.concat(", ",n[t].time)),markersFriends.addLayer(i)},error:function(n,t,i){console.log("getfriendslocations error status: "+t);console.log("Error: "+i)}}))}function SaveSettings(){$.cookie("settings_scriptTextCheckBox",$("#scriptTextCheckBox").is(":checked"));$.cookie("settings_imagesCheckBox",$("#imagesCheckBox").is(":checked"));$.cookie("settings_loopTrackCheckBox",$("#loopTrackCheckBox").is(":checked"));$.cookie("settings_usePanoramioImagesCheckBox",$("#usePanoramioImagesCheckBox").is(":checked"));$.cookie("settings_useSYTImagesCheckBox",$("#useSYTImagesCheckBox").is(":checked"));$.cookie("settings_useGooglePlacesCheckBox",$("#useGooglePlacesCheckBox").is(":checked"));$.cookie("settings_useSYTPlacesCheckBox",$("#useSYTPlacesCheckBox").is(":checked"));$.cookie("settings_mapStyle",$("#mapStyle option:selected").val());$.cookie("settings_volume",$("#slider").slider("value"));$.cookie("settings_mute",audio.muted)}function LoadSettings(){if(typeof $.cookie("settings_scriptTextCheckBox")!="undefined"){var n=$.cookie("settings_scriptTextCheckBox")=="true",t=$.cookie("settings_imagesCheckBox")=="true",i=$.cookie("settings_mute")=="true",r=$.cookie("settings_loopTrackCheckBox")=="true";$("#scriptTextCheckBox").prop("checked",n);$("#imagesCheckBox").prop("checked",t);$("#loopTrackCheckBox").prop("checked",r);$("#usePanoramioImagesCheckBox").prop("checked",$.cookie("settings_usePanoramioImagesCheckBox")=="true");$("#useSYTImagesCheckBox").prop("checked",$.cookie("settings_useSYTImagesCheckBox")=="true");$("#useGooglePlacesCheckBox").prop("checked",$.cookie("settings_useGooglePlacesCheckBox")=="true");$("#useSYTPlacesCheckBox").prop("checked",$.cookie("settings_useSYTPlacesCheckBox")=="true");n&&$("#textToReadArea0").toggle("fold",1e3);t||$("#imageDiv0").toggle("fold",1e3);i&&clickMute()}typeof $.cookie("settings_mapStyle")!="undefined"&&($("#mapStyle").val($.cookie("settings_mapStyle")),selectMapStyle());typeof $.cookie("settings_volume")!="undefined"&&$("#slider").slider("value",$.cookie("settings_volume"))}function clickMute(){audio.muted?(audio.muted=!1,$("#mute").css("background-image","url(img/unmute.png )")):(audio.muted=!0,$("#mute").css("background-image","url(img/mute.png )"))}function doStartStop(){isTrackLoaded?($("#continuePauseButton").removeAttr("disabled"),isTrackPaused?(isTrackPaused=!isTrackPaused,typeof animatedMarker!="undefined"&&animatedMarker.startagain(),track.audioSrc&&track.audioSrc.length>0&&audio.play(),scrollerEnabled=!0,$("#continuePauseButton").css("background-image","url(img/pause.png )"),$("#showGoesOn").length>0&&$("#showGoesOn").val("1")):(isTrackPaused=!isTrackPaused,typeof animatedMarker!="undefined"&&animatedMarker.stop(),audio.pause(),scrollerEnabled=!1,$("#continuePauseButton").css("background-image","url(img/play.png )"),$("#showGoesOn").length>0&&$("#showGoesOn").val("0"))):$("#continuePauseButton").attr("disabled","disabled")}function showPhotos(n,t,i){var r;if(i||(i=n.photoLocationTolerancy/1e3),i||(i=.1),$("#usePanoramioImagesCheckBox").is(":checked")&&n.usePanoramioImages!="No"){var u=$("#imageDiv").height(),e=u>150?"medium":"small",f=flickrUrl.replace("{4}","50").replace("{0}",(t.lng-i).toString()).replace("{1}",(t.lat-i).toString()).replace("{2}",(t.lng+i).toString()).replace("{3}",(t.lat+i).toString());$.ajax({dataType:"json",url:f,success:function(n){for(var u={photos:[]},r=0;r<n.photos.photo.length;r++){var f="https://farm{0}.staticflickr.com/{1}/{2}_{3}".replace("{0}",n.photos.photo[r].farm).replace("{1}",n.photos.photo[r].server).replace("{2}",n.photos.photo[r].id).replace("{3}",n.photos.photo[r].secret),e=f+"_q.jpg",o=f+".jpg",s={height:150,width:150,photo_file_url:e,photo_url:o,photo_title:n.photos.photo[r].title,owner_name:n.photos.photo[r].owner};u.photos.push(s)}get_panoramas_panoramio_success(u,t,i)},error:function(n,r,u){console.log("Panoramio status: "+r);console.log("Error: "+u);get_panoramas_panoramio_success({photos:[]},t,i)}})}else r={photos:[]},get_panoramas_panoramio_success(r,t,i)}function get_panoramas_panoramio_success(n,t,i){var r;if($("#useSYTImagesCheckBox").is(":checked")&&track.useSYTImages!="No"){var u=$("#imageDiv").height(),f=u>150?"medium":"small",e="services/get_panoramas.aspx?set=full&from=0&to="+track.numOfPhotos.toString()+"&miny="+(t.lat-i).toString()+"&minx="+(t.lng-i).toString()+"&maxy="+(t.lat+i).toString()+"&maxx="+(t.lng+i).toString()+"&size="+f+"&mapfilter=true&order=popularity&callback=?";$.ajax({dataType:"jsonp",url:e,success:function(r){get_panoramas_seeyourtravel_success(n,r,t,i)},error:function(t,r,u){console.log("Status: "+r);console.log("Error: "+u);get_panoramas_seeyourtravel_success(n,{photos:[]},i)}})}else r={photos:[]},get_panoramas_seeyourtravel_success(n,r,i)}function isPortrait(){var n=window.innerWidth,t=window.innerHeight;return n<t}function get_panoramas_seeyourtravel_success(n,t,i){var s=$("#imageDiv").height(),l=$("#imageDiv").width(),r=t.photos.concat(n.photos),e,u,c;for(shuffle(r),count=r.length,$("#lblCoord").text(i.lat+" "+i.lng),e=imageDiv.children(),e.fadeOut(100),e.empty(),u=0;u<r.length;u++){var h=document.createElement("li"),o=document.createElement("a"),f=document.createElement("img");o.href=r[u].photo_url;o.target="_blank";f.width=r[u].width*s/r[u].height;f.height=s;cacheImages==!0?getFromCacheOrServer(r[u].photo_file_url,f,function(n,t){n.src=t}):f.src=r[u].photo_file_url;c=$.t("Photo from {0} by {1}. Click to open the source.");f.title=c.format([r[u].photo_title,r[u].owner_name]);f.classList.add("photo");o.appendChild(f);h.appendChild(o);e[0].appendChild(h)}curX=0;scrollerContent.children().clone().appendTo(scrollerContent);scrollerContent.children().each(function(){var n=$(this),t;n.css("left",curX);t=n.children().children()[0];curX+=t.width});fullW=curX/2;viewportW=scroller.width();e.fadeIn(100)}function GPXtoLatLng(n){var i="",r,t;for(xmlhttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),xmlhttp.open("GET",n+"?"+Math.random(),!1),xmlhttp.send(),xmlDoc=xmlhttp.responseXML,r=xmlDoc.getElementsByTagName("trkpt"),t=0;t<r.length;t++)i.length>0&&(i+=","),i+="["+r[t].getAttribute("lat").toString()+","+r[t].getAttribute("lon").toString()+"]";return"["+i+"]"}function selectMapStyle(){var n=$("#mapStyle option:selected").val();map.removeLayer(tileLayer);tileLayer=L.tileLayer(mapTileUrl,{attribution:'SeeYourTravel.com &copy; Map data &copy; <a href="https://www.mapbox.com/">MapBox<\/a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA<\/a>, Imagery © <a href="http://cloudmade.com">CloudMade<\/a> <img src="img/poweredbygoolge/desktop/powered-by-google-on-white.png"/>',maxZoom:18,id:n});tileLayer.addTo(map)}function fixTrackData(n){for(var u,f,i=[],r=0,t=0;t<n.trackData.length;t++)u=n.trackData[t],f=pointToLatLng(u),i.push(f),t>0&&(r=r+i[t].distanceTo(i[t-1]));n.trackData=i;n.avgDistM=r/(t-1)}function loadTrack(n,t){var i=n+"?"+Math.random();$.ajax({url:i,dataType:"json",error:function(n,t,i){console.log("loadTrack error: "+t);console.log("Error: "+i)},success:function(n){var i=n;i.trackGpx&&(i.trackData=$.parseJSON(GPXtoLatLng(translateTracksContentPath(i.trackGpx))));fixTrackData(i);$("#textToReadArea").length>0&&(textToReadArea.innerHTML=isNullOrEmpty(i.textToRead)?"":$.ajax({url:translateTracksContentPath(i.textToRead+"?"+Math.random()),async:!1}).responseText);t(i)}})}function init(n,t){if(typeof map!="undefined"?(markers.clearLayers(),map.removeLayer(markers)):(map=L.map("map",{zoomControl:!1}),tileLayer=L.tileLayer(mapTileUrl,{attribution:'SeeYourTravel.com &copy; Map data &copy; <a target-"_blank" href="http://openstreetmap.org">OpenStreetMap<\/a> contributors, <a target-"_blank" href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA<\/a>, Imagery © <a target-"_blank" href="http://flickr.com">Flickr<\/a> <img src="img/poweredbygoolge/desktop/powered-by-google-on-white.png"/>',maxZoom:20,id:"mapbox.streets"}),tileLayer.addTo(map),L.control.scale({position:"bottomleft"}).addTo(map),L.control.zoom({position:"topright"}).addTo(map)),markers=new L.FeatureGroup,map.addLayer(markers),typeof markersFriends=="undefined"&&(markersFriends=new L.FeatureGroup,markers.addLayer(markersFriends)),typeof markersTracks=="undefined"&&(markersTracks=new L.FeatureGroup,markers.addLayer(markersTracks)),markerWhereIAm=L.marker(new L.LatLng(1e3,1e3),{icon:iconWhereIAm,zIndexOffset:100}).bindPopup(globalUserName),markers.addLayer(markerWhereIAm),showLocation(),n){var i=translateTracksPath(n+".js");loadTrack(i,function(n){var r,i,s;track=n;var f=L.icon({iconUrl:translateTracksContentPath(track.icon),iconSize:[markerSize,markerSize],iconAnchor:[1,markerSize],shadowUrl:null}),e=new Date(2e3,2),h={distance:track.velocityMetersPerSec,interval:1e3,icon:f,autoStart:!1,onEnd:function(){$("#loopTrackCheckBox").is(":checked")&&animatedMarker.start()},onStep:function(n){counter++;n.hasOwnProperty("syt_text")&&n.syt_text!=""&&toastr.info(n.syt_text,"",{timeOut:5e3,extendedTimeOut:1e4});n.hasOwnProperty("syt_audio")&&(audio.src=translateTracksContentPath(n.syt_audio),audio.play());var t=new Date;(t.getTime()-e.getTime())/1e3>updateIntervalSeconds&&(map.setView([n.lat,n.lng],map.getZoom()),showPhotos(track,n),e=t)}};for(r=0;r<track.trackData.length;r++)if(i=track.trackData[r],i.hasOwnProperty("syt_text")&&i.syt_text!=""){var c=L.icon({iconUrl:"img/info.png",iconSize:[25,25],iconAnchor:[13,25]}),o=i.syt_text.toString(),u=document.createElement("a");u.innerHTML="<p>"+o+"<\/p>";u.alt=o;s=L.marker(new L.LatLng(i.lat,i.lng),{icon:c}).bindPopup(u);markers.addLayer(s)}animatedMarker=L.animatedMarker(track.trackData,h);animatedMarker.setIcon(f);markers.addLayer(animatedMarker);line=L.polyline(track.trackData,{color:"green"});markers.addLayer(line);markerStart=L.marker(track.trackData[0]).bindPopup("Start");markers.addLayer(markerStart);markerFinish=L.marker(track.trackData[track.trackData.length-1]).bindPopup("Finish");markers.addLayer(markerFinish);map.setView(track.trackData[0],track.defaultScale?track.defaultScale:8);track.audioSrc&&track.audioSrc.length>0&&(audio.src=translateTracksContentPath(track.audioSrc),track.audioVolume&&(audio.volume=track.audioVolume?track.audioVolume:.8,$("#slider").slider("value",audio.volume)));addMarkersNearAll(track.trackData,GOOGLE_TYPES);isTrackLoaded=!0;t&&t()})}}function addMarkersNearAll(n,t){for(var f,r,i=0;i<myMarkers.length;i++)f=myMarkers[i],map.removeLayer(f);for(myMarkers=[],allMarkers=[],r=3,i=0;i<r;i++){var e=Math.round(n.length*i/3),o=Math.round(n.length*(i+1)/3),u=Math.round(n.length/(10*r));u==0&&(u=1);doSetTimeout(n,t,e,o,u,i)}}function doSetTimeout(n,t,i,r,u,f){setTimeout(function(){addMarkersNearRange(n,t,i,r,u,f%2==1)},f*5e3+1)}function addMarkersNearRange(n,t,r,u,f,e){for(i=r;i<u;i+=f){var o=n[i];addMarkersNear(o.lat,o.lng,t,e)}}function addMarkersNear(n,t,i){var u=new google.maps.LatLng(n,t),f={location:u,radius:MAX_GOOGLE_RADIUS,types:i},r;$("#useGooglePlacesCheckBox").is(":checked")&&track.useGooglePlaces!="No"?(r=new google.maps.places.PlacesService(map2),r.nearbySearch(f,callbackGoodlePlacesSearch)):get_places_googlehere_success([])}function callbackGoodlePlacesSearch(n,t){t==google.maps.places.PlacesServiceStatus.OK?(n.length>MAX_GOOGLE_PLACES&&(n=n.slice(0,MAX_GOOGLE_PLACES)),get_places_googlehere_success(n)):get_places_googlehere_success([])}function callbackHerePlacesSearch(n){n.length>MAX_HERE_PLACES&&(n=n.slice(0,MAX_HERE_PLACES));get_places_googlehere_success(n)}function get_places_googlehere_success(n){if($("#useSYTPlacesCheckBox").is(":checked")&&track.useSYTPlaces!="No")$.ajax({dataType:"jsonp",url:"services/get_places.aspx?callback=?",success:function(t){get_SYT_getplaces_success(n,t.results)},error:function(t,i,r){r.toString().indexOf("not called")==-1?console.log("get_places error status: "+i+", error: "+r):get_SYT_getplaces_success(n,[])}});else get_SYT_getplaces_success(n,[])}function get_SYT_getplaces_success(n,t){for(var i=0;i<Math.min(n.length,100);i++)createPhotoMarker(n[i],!0);for(i=0;i<Math.min(t.length,100);i++)createPhotoMarker(t[i],!1)}function shuffle(n){for(var t=n.length,r,i;0!==t;)i=Math.floor(Math.random()*t),t-=1,r=n[t],n[t]=n[i],n[i]=r;return n}function createPhotoMarker(n,t){var r,f,i,u;if(allMarkers.indexOf(n.id)<0)allMarkers.push(n.id);else return;(r=n.photos,r)&&(f=L.icon({iconUrl:n.types.indexOf("lodging")>=0?"img/lodging.png":n.types.indexOf("restaurant")>=0?"img/restaurant1.png":n.types.indexOf("museum")>=0?"img/museum.png":n.types.indexOf("park")>=0?"img/park.png":n.types.indexOf("bakery")>=0?"img/bakery.png":n.types.indexOf("zoo")>=0?"img/zoo.png":"img/something.png",iconSize:[26,35]}),i=document.createElement("a"),i.innerHTML="<p>"+n.name+"<\/p><img height='100px' width='100px' src='"+(t?r[0].getUrl({maxWidth:100,maxHeight:100}):r[0].raw_reference.fife_url)+"'/>",i.alt=n.name,i.onclick=function(){window.open("https://www.google.com.ua/search?q="+n.name,"_blank")},u=L.marker(new L.LatLng(t?n.geometry.location.lat():n.geometry.location.lat,t?n.geometry.location.lng():n.geometry.location.lng),{icon:f}).bindPopup(i),myMarkers.push(u),markers.addLayer(u))}function getFromCacheOrServer(n,t,i){var u=$.jStorage.get(n),r;u?i(t,u):(r=new XMLHttpRequest,r.open("GET",n,!0),r.responseType="blob",r.onload=function(){if(this.status==200){var u=new Blob([this.response],{type:"image/png"}),r=new window.FileReader;r.readAsDataURL(u);r.onloadend=function(r){var u=r.target.result;$.jStorage.set(n,u,{TTL:864e5});i(t,u)}}},r.send())}var tracksFolder="tracks/",mapTileUrl="https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoib2x0dXJ1YSIsImEiOiJlODQ4ZTI2MWI4OGZkZjUyNDRiNjY4MDFkZGI0ODc4NyJ9.iiCb_tZgs_ipvEv3s6Zx0A",flickrUrl="https://api.flickr.com/services/rest/?method=flickr.photos.search&bbox={0}%2C{1}%2C{2}%2C{3}&per_page={4}&format=json&nojsoncallback=1&api_key=2203a1e292f7b65958730b236c0756fa",MAX_GOOGLE_PLACES=10,MAX_HERE_PLACES=50,MAX_GOOGLE_RADIUS=1e4,GOOGLE_TYPES=["lodging","restaurant","museum","park","bakery","zoo"],sidePanelWidth=200,cacheImages=!1,updateIntervalSeconds=5,scrollerEnabled=!1,scroller,scrollerContent,curX,fullW,viewportW,versionUrl="services/get_version.aspx",iconWhereIAm=L.icon({iconUrl:"img/youarehere.png",iconSize:[30,50],iconAnchor:[15,50]}),iconFriend=L.icon({iconUrl:"img/friendlocation.png",iconSize:[30,30],iconAnchor:[15,30]}),isTrackLoaded=!1,iOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,isTrackPaused=!iOS,myMarkers=[];$(function(){onBodyResize();$.ajax({url:versionUrl,success:function(n){var t=$("<input/>",{type:"hidden",id:"version",value:n});t.appendTo("form")},error:function(n,t,i){console.log("get version error: "+t);console.log("Error: "+i)}});scroller=$("#imageDiv0 div.innerScrollArea");scrollerContent=scroller.children("ul");curX=0;fullW=1;var n={curSpeed:0,fullSpeed:2},t=$(n),i=function(n,i){i===undefined&&(i=600);t.stop(!0).animate({curSpeed:n},i)},r=function(){if(scrollerEnabled){var i=scroller.scrollLeft(),t=i+n.curSpeed;t>fullW*2-scroller.width()&&(t-=fullW);scroller.scrollLeft(t)}};setInterval(r,20);i(n.fullSpeed)});